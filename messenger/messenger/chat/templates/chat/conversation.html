{% extends 'chat/base.html' %}

{% block content %}
<div style="display: grid; grid-template-rows: auto 1fr auto; height: 85vh; gap: 10px;">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ—Å–µ–¥—ã -->
    <div style="background: white; padding: 15px; border-radius: 10px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="width: 45px; height: 45px; background: #1877f2; border-radius: 50%;
                  display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">
            {{ other_user.username|first|upper }}
        </div>
        <div>
            <h3 style="margin: 0; color: #1877f2;">{{ other_user.username }}</h3>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                {% if other_user.is_online %}üü¢ –í —Å–µ—Ç–∏{% else %}‚ö´ –ù–µ –≤ —Å–µ—Ç–∏{% endif %}
            </p>
        </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="chat-messages" style="background: white; padding: 20px; border-radius: 10px; overflow-y: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket -->
    </div>

    <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; gap: 10px;">
            <input type="text" id="chat-message-input"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                   style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; font-size: 16px; outline: none;">
            <button id="chat-message-submit" class="btn" style="border-radius: 25px; padding: 12px 25px; font-size: 16px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

{{ conversation.id|json_script:"conversation-id" }}
{{ user.id|json_script:"user-id" }}
{{ user.username|json_script:"username" }}

<script>
const conversationId = JSON.parse(document.getElementById('conversation-id').textContent);
const userId = JSON.parse(document.getElementById('user-id').textContent);
const username = JSON.parse(document.getElementById('username').textContent);

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–µ–π
let historyLoaded = false;
let messagesCount = 0;
const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/' + conversationId + '/'
);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
function formatTime(timestamp) {
    if (!timestamp) return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    const date = typeof timestamp === 'string' ? new Date(timestamp) : timestamp;
    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑
function scrollToBottom() {
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessageToChat(message, messageUsername, messageUserId, timestamp, messageId, isHistory = false) {
    const messagesDiv = document.getElementById('chat-messages');

    // –£–±–∏—Ä–∞–µ–º –∑–∞–≥–ª—É—à–∫—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    if (!historyLoaded && (messagesDiv.innerHTML.includes('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π') || messagesDiv.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞'))) {
        messagesDiv.innerHTML = '';
        historyLoaded = true;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ ID)
    if (messageId) {
        const existingMessage = document.querySelector(`[data-message-id="${messageId}"]`);
        if (existingMessage) {
            return; // –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç
        }
    }

    const messageDiv = document.createElement('div');
    if (messageId) {
        messageDiv.setAttribute('data-message-id', messageId);
    }

    const isCurrentUser = parseInt(messageUserId) === parseInt(userId);
    const displayTime = formatTime(timestamp);

    messageDiv.style.marginBottom = '15px';
    messageDiv.style.display = 'flex';
    messageDiv.style.justifyContent = isCurrentUser ? 'flex-end' : 'flex-start';

    messageDiv.innerHTML = `
        <div style="max-width: 70%;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px; ${isCurrentUser ? 'flex-direction: row-reverse' : ''}">
                <strong style="color: #1877f2; font-size: 14px;">${messageUsername}</strong>
                <small style="color: #666; font-size: 12px;">${displayTime}</small>
            </div>
            <div style="background: ${isCurrentUser ? '#1877f2' : '#f0f2f5'};
                        color: ${isCurrentUser ? 'white' : 'black'};
                        padding: 10px 15px; border-radius: 18px;
                        ${isCurrentUser ? 'border-bottom-right-radius: 5px;' : 'border-bottom-left-radius: 5px;'}
                        font-size: 15px; line-height: 1.4;">
                ${message}
            </div>
        </div>
    `;

    messagesDiv.appendChild(messageDiv);
    messagesCount++;

    // –î–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ù–ï –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ä–∞–∑—É, –∂–¥–µ–º –ø–æ–∫–∞ –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
    // –î–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - —Å—Ä–∞–∑—É –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
    if (!isHistory) {
        scrollToBottom();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∑–∞–≥–ª—É—à–∫–∏ "–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"
function showNoMessages() {
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.innerHTML = `
        <div style="text-align: center; color: #666; margin-top: 50px;">
            <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
            <h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
            <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p>
        </div>
    `;
}

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
let historyMessagesProcessed = 0;
let totalHistoryMessages = 0;

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.innerHTML = `
        <div style="text-align: center; color: #666; margin-top: 50px;">
            <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π...</h3>
        </div>
    `;
});

chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.type === 'history_message') {
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        addMessageToChat(
            data.message,
            data.username,
            data.user_id,
            data.timestamp,
            data.message_id,
            true // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        );

        historyMessagesProcessed++;

        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ - –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
        if (historyMessagesProcessed >= totalHistoryMessages) {
            setTimeout(scrollToBottom, 100);
        }

    } else if (data.type === 'message') {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        addMessageToChat(
            data.message,
            data.username,
            data.user_id,
            data.timestamp,
            data.message_id,
            false // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        );

    } else if (data.type === 'history_info') {
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
        totalHistoryMessages = data.total_messages;
    } else if (data.type === 'no_messages') {
        // –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
        showNoMessages();
        historyLoaded = true;
    }
};

chatSocket.onopen = function(e) {
    console.log('WebSocket connected successfully');
};

chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');

    // –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–ª–æ—Å—å –∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
    const messagesDiv = document.getElementById('chat-messages');
    if (messagesDiv.children.length === 0 || messagesDiv.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞')) {
        showNoMessages();
    }
};

chatSocket.onerror = function(e) {
    console.error('WebSocket error:', e);
};

// –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM, –µ—Å–ª–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"
setTimeout(() => {
    const messagesDiv = document.getElementById('chat-messages');
    if (messagesDiv.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π...')) {
        showNoMessages();
    }
}, 3000);

// –§–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
document.getElementById('chat-message-input').focus();

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
document.getElementById('chat-message-input').onkeyup = function(e) {
    if (e.keyCode === 13) {
        document.getElementById('chat-message-submit').click();
    }
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–ª–∏–∫—É
document.getElementById('chat-message-submit').onclick = function() {
    const messageInput = document.getElementById('chat-message-input');
    const message = messageInput.value.trim();

    if (message) {
        chatSocket.send(JSON.stringify({
            'message': message,
            'username': username,
            'user_id': userId
        }));
        messageInput.value = '';
    }
};
</script>
{% endblock %}