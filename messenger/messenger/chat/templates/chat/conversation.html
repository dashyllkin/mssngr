{% extends 'chat/base.html' %}

{% block content %}
<div style="display: grid; grid-template-rows: auto 1fr auto; height: 85vh; gap: 10px;">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ—Å–µ–¥—ã -->
    <div style="background: white; padding: 15px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="width: 45px; height: 45px; background: #1877f2; border-radius: 50%;
                      display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">
                {{ other_user.username|first|upper }}
            </div>
            <div>
                <h3 style="margin: 0; color: #1877f2;">{{ other_user.username }}</h3>
                <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                    {% if other_user.is_online %}üü¢ –í —Å–µ—Ç–∏{% else %}‚ö´ –ù–µ –≤ —Å–µ—Ç–∏{% endif %}
                </p>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–æ —á–∞—Ç–∞ -->
        <form method="post" action="{% url 'delete_conversation' conversation.id %}"
              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å —á–∞—Ç —Å {{ other_user.username }}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.');">
            {% csrf_token %}
            <button type="submit" class="btn" style="background: #dc3545; border-radius: 20px;">
                –£–¥–∞–ª–∏—Ç—å —á–∞—Ç
            </button>
        </form>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="chat-messages" style="background: white; padding: 20px; border-radius: 10px; overflow-y: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket -->
    </div>

    <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç–º–æ–¥–∑–∏ -->
    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <!-- –≠–º–æ–¥–∑–∏-–ø–∞–Ω–µ–ª—å -->
        <div id="emoji-panel" style="display: none; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
            <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; max-height: 120px; overflow-y: auto;">
                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å–º–∞–π–ª–∏–∫–∏ -->
                <span class="emoji" data-emoji="üòÄ">üòÄ</span>
                <span class="emoji" data-emoji="üòÉ">üòÉ</span>
                <span class="emoji" data-emoji="üòÑ">üòÑ</span>
                <span class="emoji" data-emoji="üòÅ">üòÅ</span>
                <span class="emoji" data-emoji="üòÜ">üòÜ</span>
                <span class="emoji" data-emoji="üòÖ">üòÖ</span>
                <span class="emoji" data-emoji="üòÇ">üòÇ</span>
                <span class="emoji" data-emoji="ü§£">ü§£</span>

                <!-- ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–º–æ–¥–∑–∏ ... -->
            </div>
        </div>

        <div style="display: flex; gap: 10px; align-items: flex-end;">
            <!-- –ö–Ω–æ–ø–∫–∞ —ç–º–æ–¥–∑–∏ -->
            <button id="emoji-toggle" type="button" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 5px; flex-shrink: 0;" title="–°–º–∞–π–ª–∏–∫–∏">
                üòä
            </button>

            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
            <input type="text" id="chat-message-input"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                   style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; font-size: 16px; outline: none; min-height: 20px;">

            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <button id="chat-message-submit" class="btn" style="border-radius: 25px; padding: 12px 25px; font-size: 16px; flex-shrink: 0;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
<div id="message-context-menu" style="display: none; position: fixed; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; padding: 5px 0; min-width: 150px;">
    <div id="context-menu-delete" style="padding: 8px 12px; cursor: pointer; color: #dc3545; font-size: 14px; display: none;">
        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    </div>
    <div id="context-menu-copy" style="padding: 8px 12px; cursor: pointer; color: #333; font-size: 14px;">
        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
    </div>
</div>

{{ conversation.id|json_script:"conversation-id" }}
{{ user.id|json_script:"user-id" }}
{{ user.username|json_script:"username" }}

<script>
const conversationId = JSON.parse(document.getElementById('conversation-id').textContent);
const userId = JSON.parse(document.getElementById('user-id').textContent);
const username = JSON.parse(document.getElementById('username').textContent);

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–µ–π
let historyLoaded = false;
let messagesCount = 0;
const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/' + conversationId + '/'
);

// –≠–º–æ–¥–∑–∏-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
let emojiPanelVisible = false;

// –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
let contextMenu = null;
let currentContextMessageId = null;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ —ç–º–æ–¥–∑–∏
function toggleEmojiPanel() {
    const emojiPanel = document.getElementById('emoji-panel');
    emojiPanelVisible = !emojiPanelVisible;

    if (emojiPanelVisible) {
        emojiPanel.style.display = 'block';
    } else {
        emojiPanel.style.display = 'none';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —ç–º–æ–¥–∑–∏ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
function insertEmoji(emoji) {
    const messageInput = document.getElementById('chat-message-input');
    const cursorPos = messageInput.selectionStart;
    const textBefore = messageInput.value.substring(0, cursorPos);
    const textAfter = messageInput.value.substring(cursorPos);

    messageInput.value = textBefore + emoji + textAfter;
    messageInput.focus();
    messageInput.selectionStart = cursorPos + emoji.length;
    messageInput.selectionEnd = cursorPos + emoji.length;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
function formatTime(timestamp) {
    if (!timestamp) return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    const date = typeof timestamp === 'string' ? new Date(timestamp) : timestamp;
    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–Ω–∏–∑
function scrollToBottom() {
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
function showContextMenu(event, messageId, isCurrentUser, isDeleted) {
    event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é

    contextMenu = document.getElementById('message-context-menu');
    currentContextMessageId = messageId;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö –∏ –Ω–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    const deleteBtn = document.getElementById('context-menu-delete');
    if (isCurrentUser && !isDeleted) {
        deleteBtn.style.display = 'block';
    } else {
        deleteBtn.style.display = 'none';
    }

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é —Ä—è–¥–æ–º —Å –∫—É—Ä—Å–æ—Ä–æ–º
    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';

    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –º–µ–Ω—é –Ω–µ –≤—ã–π–¥–µ—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —ç–∫—Ä–∞–Ω–∞
    const rect = contextMenu.getBoundingClientRect();
    if (rect.right > window.innerWidth) {
        contextMenu.style.left = (event.pageX - rect.width) + 'px';
    }
    if (rect.bottom > window.innerHeight) {
        contextMenu.style.top = (event.pageY - rect.height) + 'px';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
function hideContextMenu() {
    if (contextMenu) {
        contextMenu.style.display = 'none';
        currentContextMessageId = null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
function copyMessageText(messageId) {
    const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageDiv) {
        const messageContent = messageDiv.querySelector('div > div:last-child');
        if (messageContent) {
            const text = messageContent.textContent || messageContent.innerText;
            navigator.clipboard.writeText(text).then(() => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showTempNotification('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            }).catch(() => {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showTempNotification('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            });
        }
    }
    hideContextMenu();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showTempNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        z-index: 1001;
        font-size: 14px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        document.body.removeChild(notification);
    }, 2000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
function deleteMessage(messageId) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
        chatSocket.send(JSON.stringify({
            'type': 'delete_message',
            'message_id': parseInt(messageId),
            'user_id': userId
        }));
    }
    hideContextMenu();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessageToChat(message, messageUsername, messageUserId, timestamp, messageId, isHistory = false, canDelete = false, isDeleted = false) {
    const messagesDiv = document.getElementById('chat-messages');

    // –£–±–∏—Ä–∞–µ–º –∑–∞–≥–ª—É—à–∫—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    if (!historyLoaded && (messagesDiv.innerHTML.includes('–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π') || messagesDiv.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞'))) {
        messagesDiv.innerHTML = '';
        historyLoaded = true;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ ID)
    if (messageId) {
        const existingMessage = document.querySelector(`[data-message-id="${messageId}"]`);
        if (existingMessage) {
            return; // –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç
        }
    }

    const messageDiv = document.createElement('div');
    if (messageId) {
        messageDiv.setAttribute('data-message-id', messageId);
    }

    const isCurrentUser = parseInt(messageUserId) === parseInt(userId);
    const displayTime = formatTime(timestamp);

    messageDiv.style.marginBottom = '15px';
    messageDiv.style.display = 'flex';
    messageDiv.style.justifyContent = isCurrentUser ? 'flex-end' : 'flex-start';
    messageDiv.style.position = 'relative';
    messageDiv.style.cursor = 'context-menu';

    // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
    const messageContent = isDeleted ?
        '<em style="color: #999; font-style: italic;">–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</em>' :
        message;

    messageDiv.innerHTML = `
        <div style="max-width: 70%; position: relative;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px; ${isCurrentUser ? 'flex-direction: row-reverse' : ''}">
                <strong style="color: #1877f2; font-size: 14px;">${messageUsername}</strong>
                <small style="color: #666; font-size: 12px;">${displayTime}</small>
            </div>
            <div style="background: ${isDeleted ? 'transparent' : (isCurrentUser ? '#1877f2' : '#f0f2f5')};
                        color: ${isDeleted ? '#999' : (isCurrentUser ? 'white' : 'black')};
                        padding: 10px 15px; border-radius: 18px;
                        ${isCurrentUser ? 'border-bottom-right-radius: 5px;' : 'border-bottom-left-radius: 5px;'}
                        font-size: 15px; line-height: 1.4; word-wrap: break-word;
                        ${isDeleted ? 'border: 1px dashed #ddd;' : ''}
                        user-select: text;">
                ${messageContent}
            </div>
        </div>
    `;

    messagesDiv.appendChild(messageDiv);
    messagesCount++;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    if (!isDeleted) {
        messageDiv.addEventListener('contextmenu', function(e) {
            showContextMenu(e, messageId, isCurrentUser, isDeleted);
        });

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
        messageDiv.addEventListener('mouseenter', function() {
            if (!isDeleted) {
                this.style.backgroundColor = 'rgba(0,0,0,0.02)';
                this.style.borderRadius = '10px';
                this.style.margin = '0 -5px';
                this.style.padding = '0 5px';
            }
        });

        messageDiv.addEventListener('mouseleave', function() {
            if (!isDeleted) {
                this.style.backgroundColor = '';
                this.style.borderRadius = '';
                this.style.margin = '';
                this.style.padding = '';
            }
        });
    }

    // –î–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ù–ï –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ä–∞–∑—É, –∂–¥–µ–º –ø–æ–∫–∞ –≤—Å—è –∏—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
    // –î–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π - —Å—Ä–∞–∑—É –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
    if (!isHistory) {
        scrollToBottom();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∑–∞–≥–ª—É—à–∫–∏ "–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"
function showNoMessages() {
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.innerHTML = `
        <div style="text-align: center; color: #666; margin-top: 50px;">
            <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
            <h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
            <p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p>
        </div>
    `;
}

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
let historyMessagesProcessed = 0;
let totalHistoryMessages = 0;

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.innerHTML = `
        <div style="text-align: center; color: #666; margin-top: 50px;">
            <div style="font-size: 48px; margin-bottom: 20px;">üí¨</div>
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π...</h3>
        </div>
    `;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–º–æ–¥–∑–∏-–ø–∞–Ω–µ–ª–∏
    const emojiToggle = document.getElementById('emoji-toggle');
    const emojiPanel = document.getElementById('emoji-panel');
    const emojis = document.querySelectorAll('.emoji');

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —ç–º–æ–¥–∑–∏
    if (emojiToggle) {
        emojiToggle.addEventListener('click', toggleEmojiPanel);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–º–æ–¥–∑–∏
    if (emojis) {
        emojis.forEach(emoji => {
            emoji.addEventListener('click', function() {
                insertEmoji(this.getAttribute('data-emoji'));
            });

            // –°—Ç–∏–ª–∏ –¥–ª—è —ç–º–æ–¥–∑–∏ –≤ –ø–∞–Ω–µ–ª–∏
            emoji.style.cursor = 'pointer';
            emoji.style.padding = '5px';
            emoji.style.borderRadius = '5px';
            emoji.style.textAlign = 'center';
            emoji.style.fontSize = '18px';

            emoji.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#e9ecef';
            });

            emoji.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'transparent';
            });
        });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ —ç–º–æ–¥–∑–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
    document.addEventListener('click', function(event) {
        if (emojiPanel && !emojiPanel.contains(event.target) && event.target !== emojiToggle) {
            emojiPanelVisible = false;
            emojiPanel.style.display = 'none';
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    const contextMenu = document.getElementById('message-context-menu');
    const deleteOption = document.getElementById('context-menu-delete');
    const copyOption = document.getElementById('context-menu-copy');

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—É–Ω–∫—Ç–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    deleteOption.addEventListener('click', function() {
        if (currentContextMessageId) {
            deleteMessage(currentContextMessageId);
        }
    });

    copyOption.addEventListener('click', function() {
        if (currentContextMessageId) {
            copyMessageText(currentContextMessageId);
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(event) {
        if (contextMenu && !contextMenu.contains(event.target)) {
            hideContextMenu();
        }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            hideContextMenu();
        }
    });

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
    document.addEventListener('contextmenu', function(event) {
        if (event.target.closest('[data-message-id]')) {
            event.preventDefault();
        }
    });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç WebSocket
chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.type === 'history_message') {
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        addMessageToChat(
            data.message,
            data.username,
            data.user_id,
            data.timestamp,
            data.message_id,
            true, // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            data.can_delete,
            data.is_deleted
        );

        historyMessagesProcessed++;

        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ - –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
        if (historyMessagesProcessed >= totalHistoryMessages) {
            setTimeout(scrollToBottom, 100);
        }

    } else if (data.type === 'message') {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        addMessageToChat(
            data.message,
            data.username,
            data.user_id,
            data.timestamp,
            data.message_id,
            false, // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            true,   // –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å (—Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è)
            false   // –ù–µ —É–¥–∞–ª–µ–Ω–æ
        );

    } else if (data.type === 'message_deleted') {
        // –û–±–Ω–æ–≤–ª—è–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const messageDiv = document.querySelector(`[data-message-id="${data.message_id}"]`);
        if (messageDiv) {
            const messageContent = messageDiv.querySelector('div > div:last-child');

            if (messageContent) {
                messageContent.innerHTML = '<em style="color: #999; font-style: italic;">–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</em>';
                messageContent.style.background = 'transparent';
                messageContent.style.color = '#999';
                messageContent.style.border = '1px dashed #ddd';
            }

            // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
            messageDiv.replaceWith(messageDiv.cloneNode(true));
        }

    } else if (data.type === 'history_info') {
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
        totalHistoryMessages = data.total_messages;
    } else if (data.type === 'no_messages') {
        // –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
        showNoMessages();
        historyLoaded = true;
    }
};

chatSocket.onopen = function(e) {
    console.log('WebSocket connected successfully');
};

chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');

    // –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–ª–æ—Å—å –∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
    const messagesDiv = document.getElementById('chat-messages');
    if (messagesDiv.children.length === 0 || messagesDiv.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞')) {
        showNoMessages();
    }
};

chatSocket.onerror = function(e) {
    console.error('WebSocket error:', e);
};

// –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM, –µ—Å–ª–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"
setTimeout(() => {
    const messagesDiv = document.getElementById('chat-messages');
    if (messagesDiv.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π...')) {
        showNoMessages();
    }
}, 3000);

// –§–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
document.getElementById('chat-message-input').focus();

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
document.getElementById('chat-message-input').onkeyup = function(e) {
    if (e.keyCode === 13) {
        document.getElementById('chat-message-submit').click();
    }
};

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–ª–∏–∫—É
document.getElementById('chat-message-submit').onclick = function() {
    const messageInput = document.getElementById('chat-message-input');
    const message = messageInput.value.trim();

    if (message) {
        chatSocket.send(JSON.stringify({
            'type': 'message',
            'message': message,
            'username': username,
            'user_id': userId
        }));
        messageInput.value = '';

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        if (emojiPanelVisible) {
            toggleEmojiPanel();
        }
    }
};
</script>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–º–æ–¥–∑–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
    .emoji-message {
        font-size: 18px;
        line-height: 1.2;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ —ç–º–æ–¥–∑–∏ */
    #emoji-toggle:hover {
        background-color: #f0f2f5 !important;
        transform: scale(1.1);
        transition: all 0.2s ease;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ —ç–º–æ–¥–∑–∏ */
    #emoji-panel {
        animation: fadeIn 0.2s ease-in-out;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é */
    #message-context-menu div:hover {
        background-color: #f8f9fa;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é */
    #message-context-menu {
        animation: fadeInScale 0.15s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInScale {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }
</style>
{% endblock %}